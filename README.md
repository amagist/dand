# IBM Rapid Prototyping Microsite Template

Deploys a microsite using the RPT's methodologies, allowing you to get a site running as fast as possible. Built with Mobirise, hosted on IBM Cloud. There's also an option to authenticate users using w3id, and a node-RED instance to help you deploy additional services such as a Cloudant Database, or a chatbot.


`// at some point this will all be automated`

## Step 0 - Fork this Repo, and some pre-reqs

1.  On GitHub, fork this repo, then clone it onto your local machine.
2.  Install necessary tools: `Cloud Foundary CLI`, `node & npm`
3.  Think of a unique app name for your bluemix route. Something like *client-name*-microsite would work.

## Step 1 - Generate some HTML

1.  [Download Mobirise](http://mobirise.com/)
2.  Fire it up, and drag & drop components in the builder until you've got a site. Additional pages can be added to
3.  Click `Publish` on the top right.
4.  Select Local Drive Folder. Choose the `public/pages` folder of the repo you just cloned. This will dump all html, stylesheets, and images into this repository.

## Step 2 - Configure node-RED

We recommend doing this even if you don't think you'll need node-RED. It'll give you more flexibility to add further integrations, as well as give you a space to quickly prototype apps/tools
1.  Create a CloudantDB service: if on IBM CIO Cloud, deploy a "CloudantDB Dedicated" instance, with the following naming convention `<appname>-Cloudant NoSQL DB Dedicated`. Note, to use Authentication, at the moment you must use this method, on CIO bluemix. If on the public IBM Cloud, use a normal CloudantDB, with the name `<appname>-Cloudant NoSQL DB`.
2.  Create a password hash for your admin user. This will secure the `/red` editor using a bcrypt hash, otherwise it can be edited by anyone! From the app folder in terminal/bash/cmd, run `npm install`, then run `node -e "console.log(require('bcryptjs').hashSync(process.argv[1], 8));" <password>`, replacing `<password>` with a passphrase of your choice.
3.  Paste this into the app.js on line 137 ish (try ctrl-F and searching for `// paste your password hash here`)
4.  When deployed, nodeRED will be running on /red. This is secured by the username "admin" and password just set up.

## Step 3 - Set up Authentication

If needed, follow the instructions below. If not, uncomment `return next();` on line 80 ish, which will disable authentication. For now, authentication only works on private CIO) Cloud.

1.  Register Bluemix route at [https://w3.innovate.ibm.com/tools/sso/home.html](https://w3.innovate.ibm.com/tools/sso/home.html) as an OpenIDConnect service (For the call back URL, register as `<Bluemix route>/auth/callback`)
2.  To test, use of the w3id Staging service is recommended, this uses the live directory but not the live OpenIDConnect service
3.  Download the certificate supplied as `oidc_w3id.cer` and upload to main directory of repo
4.  Update `oid-settings.js` with the configuration settings supplied by the sso registration service (including the URL of the callback)
5.  Wait. The staging provisioning job runs at :42 mins past each hour, and the SSO will start to work about 10-15 mins after this. Production SSO takes 2-4 days to get manually approved.

Note: as standard, this will authenticate all static pages generated by mobirise. To authenticate node-RED flows, use this subflow directly after a HTTP in node:
````
  [{"id":"5b7ea8bf.70a15","type":"subflow","name":"w3id login","info":"This node checks to see if the user is logged in.\nIf not, it stores the original URL and redirects\nto /login. On a successful return, it resumes at\nthe stored URL","in":[{"x":52.5,"y":48,"wires":[{"id":"a6b19b7c.903648"}]}],"out":[{"x":399,"y":122,"wires":[{"id":"a6b19b7c.903648","port":1}]}]},{"id":"a6b19b7c.903648","type":"switch","z":"5b7ea8bf.70a15","name":"User null?","property":"req.user","propertyType":"msg","rules":[{"t":"null"},{"t":"else"}],"checkall":"true","outputs":2,"x":171.5,"y":48,"wires":[["d836655d.df5988"],[]]},{"id":"d836655d.df5988","type":"change","z":"5b7ea8bf.70a15","name":"Redirect to login","rules":[{"t":"set","p":"req.session.originalUrl","pt":"msg","to":"req.originalUrl","tot":"msg"},{"t":"set","p":"statusCode","pt":"msg","to":"307","tot":"num"},{"t":"set","p":"headers.location","pt":"msg","to":"/login","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":392,"y":42,"wires":[["9acba24b.369168"]]},{"id":"9acba24b.369168","type":"http response","z":"5b7ea8bf.70a15","name":"","x":581.5,"y":42.75,"wires":[]}]
````

## Step 4 - Deploy
1. Update the manifest.yml file -
    * Appname & host should be the same as the one decided earlier
    * Under services, update `<appname>-Cloudant NoSQL DB Dedicated` for your app.
2. Use the cf command line tools to deploy - `cf push`- This will deploy your app in your area, connecting to the DB you've set up.
